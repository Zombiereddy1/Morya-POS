<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morya POS Ultimate</title>
    <meta name="theme-color" content="#2563eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; font-family: sans-serif; }
        ::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE YOUR CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPjIArz_knqjAnVpk9nLib-89sgE6yMPo",
            authDomain: "moryapos.firebaseapp.com",
            databaseURL: "https://moryapos-default-rtdb.firebaseio.com",
            projectId: "moryapos",
            storageBucket: "moryapos.firebasestorage.app",
            messagingSenderId: "736569569143",
            appId: "1:736569569143:web:3905b38d0aaecae77d7b72"
        };
        // -----------------------------

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            window.db = db; window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue;
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) { console.error("Firebase Error:", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // --- Config ---
        const ADMIN_PIN = "028987"; 
        const SHOP = { name: "Morya Matching Centre", prop: "Prof. Kapil Shinde", mobile: "7083522162", address: "Near R.K Chitale Madhyamik, Nehru Nagar, Mochi Wada, Dhule" };
        
        // --- Components ---
        const Icon = ({ name, size = 20 }) => {
            useEffect(() => window.lucide?.createIcons(), [name]);
            return <i data-lucide={name.replace(/([A-Z])/g,'-$1').toLowerCase()} width={size} height={size}></i>;
        };
        const Btn = ({ children, onClick, variant = "primary", className = "", ...props }) => {
            const variants = {
                primary: "bg-blue-600 text-white shadow-lg shadow-blue-200",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
                green: "bg-green-600 text-white shadow-lg shadow-green-200",
                black: "bg-gray-900 text-white shadow-lg",
                purple: "bg-purple-600 text-white shadow-lg shadow-purple-200",
                danger: "bg-red-50 text-red-600"
            };
            return <button onClick={onClick} className={`px-4 py-3 rounded-xl font-bold active:scale-95 flex items-center justify-center gap-2 transition-all ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };
        const Card = ({ children, onClick, className = "" }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-gray-100 p-4 ${className}`}>{children}</div>
        );

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState("loading");
            const [user, setUser] = useState(null);
            const [ready, setReady] = useState(false);
            
            // Data
            const [inv, setInv] = useState([]);
            const [txs, setTxs] = useState([]);
            
            // UI
            const [tab, setTab] = useState('pos');
            const [cart, setCart] = useState([]);
            const [search, setSearch] = useState('');
            const [activeModal, setActiveModal] = useState(null);
            
            // Edit/Selection
            const [selItem, setSelItem] = useState(null); 
            const [selColor, setSelColor] = useState(''); 
            const colorInputRef = useRef(null);

            // Checkout & Autocomplete
            const [custData, setCustData] = useState({ name: '', mobile: '' });
            const [suggestions, setSuggestions] = useState([]);
            const [lastBill, setLastBill] = useState(null);

            // 1. Init
            useEffect(() => {
                const start = () => setReady(true);
                if (window.db) start();
                else window.addEventListener('firebase-ready', start);

                const session = localStorage.getItem('morya_session');
                if (session) {
                    const s = JSON.parse(session);
                    setUser(s); setView(s.role === 'admin' ? 'admin' : 'customer');
                } else setView("auth");
                return () => window.removeEventListener('firebase-ready', start);
            }, []);

            // 2. Sync Firebase
            useEffect(() => {
                if (!ready) return;
                // Inventory Listener
                window.dbOnValue(window.dbRef(window.db, 'inventory'), (s) => {
                    const data = s.val();
                    setInv(data ? Object.values(data) : []);
                });
                // History Listener
                window.dbOnValue(window.dbRef(window.db, 'transactions'), (s) => {
                    const data = s.val();
                    setTxs(data ? Object.values(data) : []);
                });
            }, [ready]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, tab, cart, activeModal, inv]);

            // --- Logic ---

            const handleLogin = (mobile) => {
                if (mobile === '7083522162') {
                    const pin = prompt("Enter Admin PIN:");
                    if (pin === ADMIN_PIN) {
                        const u = { mobile, role: 'admin' };
                        setUser(u); setView('admin');
                        localStorage.setItem('morya_session', JSON.stringify(u));
                    } else alert("Wrong PIN");
                } else {
                    const u = { mobile, role: 'customer' };
                    setUser(u); setView('customer');
                    localStorage.setItem('morya_session', JSON.stringify(u));
                }
            };

            const logout = () => { localStorage.removeItem('morya_session'); setUser(null); setView('auth'); };

            // FIXED: Inventory Save
            const saveItemToCloud = () => {
                if(!selItem.name || !selItem.price) return alert("Name and Price required");
                const id = selItem.id || Date.now().toString();
                const newItem = { 
                    ...selItem, 
                    id, 
                    price: parseInt(selItem.price), 
                    stock: parseInt(selItem.stock) || 0,
                    colorStock: selItem.type === 'has_colors' ? (selItem.colorStock || {}) : {} 
                };
                window.dbSet(window.dbRef(window.db, 'inventory/' + id), newItem)
                    .then(() => { setActiveModal(null); setSelItem(null); })
                    .catch(e => alert("Error saving: " + e.message));
            };

            const addToCart = (item, qty = 1, color = null, isCustom = false) => {
                const cartId = item.id + (color ? `-${color}` : '');
                setCart(prev => {
                    const existing = prev.find(c => c.cartId === cartId);
                    if (existing) {
                        return prev.map(c => c.cartId === cartId ? { ...c, qty: c.qty + parseInt(qty) } : c);
                    } else {
                        return [...prev, { ...item, qty: parseInt(qty), cartId, variant: color ? `Color ${color}` : (item.variant || 'Std'), colorNumber: color, isCustom }];
                    }
                });
                setActiveModal(null); setSelColor('');
            };

            // AUTOCOMPLETE LOGIC
            const handleCustInput = (field, value) => {
                setCustData(prev => ({ ...prev, [field]: value }));
                
                if (value.length > 1) {
                    // Extract unique customers from transaction history
                    const uniqueCusts = [];
                    const seen = new Set();
                    txs.forEach(t => {
                        if (!seen.has(t.customerMobile)) {
                            seen.add(t.customerMobile);
                            uniqueCusts.push({ name: t.customerName, mobile: t.customerMobile });
                        }
                    });

                    const matches = uniqueCusts.filter(c => 
                        c.name.toLowerCase().includes(value.toLowerCase()) || 
                        c.mobile.includes(value)
                    );
                    setSuggestions(matches.slice(0, 5)); // Show top 5
                } else {
                    setSuggestions([]);
                }
            };

            const selectSuggestion = (c) => {
                setCustData({ name: c.name, mobile: c.mobile });
                setSuggestions([]);
            };

            const processPayment = () => {
                if (!custData.name || !custData.mobile) return alert("Enter Customer Details");
                const billId = Date.now().toString();
                const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
                
                inv.forEach(p => {
                    const soldItems = cart.filter(c => c.id === p.id && !c.isCustom);
                    if (soldItems.length > 0) {
                        let newStock = p.stock;
                        let newColorStock = { ...(p.colorStock || {}) };
                        soldItems.forEach(c => {
                            newStock -= c.qty;
                            if (p.type === 'has_colors' && c.colorNumber) newColorStock[c.colorNumber] = (newColorStock[c.colorNumber] || 0) - c.qty;
                        });
                        window.dbSet(window.dbRef(window.db, 'inventory/' + p.id), { ...p, stock: newStock, colorStock: newColorStock });
                    }
                });

                const bill = { id: billId, date: new Date().toISOString(), customerName: custData.name, customerMobile: custData.mobile, items: cart, total: total };
                window.dbSet(window.dbRef(window.db, 'transactions/' + billId), bill);
                setLastBill(bill); setCart([]); setActiveModal("receipt");
            };

            // PROFESSIONAL PDF (From your file)
            const generatePDF = (b) => {
                const d = new jsPDF({ unit: 'mm', format: [80, 200] }); 
                d.setFontSize(10); d.setFont("helvetica", "bold"); d.text("MORYA MATCHING", 40, 8, { align: 'center' });
                d.setFontSize(8); d.setFont("helvetica", "normal"); d.text(SHOP.prop, 40, 12, { align: 'center' }); 
                d.text(SHOP.mobile, 40, 16, { align: 'center' }); 
                d.text(d.splitTextToSize(SHOP.address, 75), 40, 20, { align: 'center' });
                
                let y = 35; 
                d.text(`#${b.id.slice(-6)}`, 5, y); d.text(new Date(b.date).toLocaleDateString(), 75, y, { align: 'right' }); y += 5; 
                d.text(`Cust: ${b.customerName}`, 5, y); y += 5;
                d.text("-------------------------------------------", 40, y, { align: 'center' }); y += 5;
                
                b.items.forEach(i => {
                    let n = i.name + (i.variant !== 'Std' ? ` (${i.variant})` : ''); 
                    d.text(n, 5, y); d.text(String(i.qty), 55, y, { align: 'right' }); d.text(String(i.price * i.qty), 75, y, { align: 'right' }); y += 5;
                });
                
                y += 2; d.text("-------------------------------------------", 40, y, { align: 'center' }); y += 5; 
                d.setFontSize(12); d.setFont("helvetica", "bold"); d.text(`TOTAL: ${b.total}`, 75, y, { align: 'right' }); 
                d.save(`Bill_${b.id.slice(-6)}.pdf`);
            };

            // TEXT PRINT INTENT (For RawBT/Thermal)
            const printText = (b) => {
                let text = `*MORYA MATCHING*\n${SHOP.address}\n\nBill: #${b.id.slice(-6)}\nDate: ${new Date(b.date).toLocaleDateString()}\nCust: ${b.customerName}\n----------------\n`;
                b.items.forEach(i => { text += `${i.name} x${i.qty} = ${i.price * i.qty}\n`; });
                text += `----------------\nTOTAL: ${b.total}\n\nThank You!\n\n\n`; // Extra lines for paper cut
                
                // Share as text (RawBT catches this)
                if(navigator.share) {
                    navigator.share({ title: 'Print Receipt', text: text }).catch(console.error);
                } else {
                    // Fallback to simple copy
                    navigator.clipboard.writeText(text);
                    alert("Receipt copied! Open RawBT or Printer app and paste.");
                }
            };

            // --- Views ---

            if (view === "loading") return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">Connecting Cloud...</div>;

            if (view === "auth") return (
                <div className="h-screen bg-blue-600 flex items-center justify-center p-6">
                    <Card className="w-full max-w-sm text-center py-10">
                        <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="store" size={32}/></div>
                        <h1 className="text-2xl font-extrabold text-blue-700">Morya POS</h1>
                        <p className="text-gray-400 text-sm mb-8">Secure Login</p>
                        <input type="tel" placeholder="Enter Mobile Number" className="w-full p-4 bg-gray-50 border rounded-xl text-center text-xl tracking-widest mb-4 font-bold"
                            onChange={(e) => { if(e.target.value.length === 10) handleLogin(e.target.value); }}
                        />
                    </Card>
                </div>
            );

            if (view === "customer") return (
                <div className="min-h-screen bg-gray-50 flex flex-col">
                    <div className="bg-blue-600 p-6 text-white rounded-b-3xl shadow-lg mb-4 flex justify-between items-center">
                        <div><h1 className="text-2xl font-bold">Morya Matching</h1><p className="opacity-80 text-sm">Welcome</p></div>
                        <button onClick={logout} className="bg-blue-700 px-3 py-1 rounded text-xs">Logout</button>
                    </div>
                    <div className="flex-1 px-4 pb-4 overflow-y-auto">
                        <h3 className="font-bold text-gray-800 mb-3">Your Orders</h3>
                        {txs.filter(t => t.customerMobile === user.mobile).length === 0 ? <p className="text-center text-gray-400 mt-10">No orders yet.</p> :
                        txs.filter(t => t.customerMobile === user.mobile).slice().reverse().map(t => (
                            <Card key={t.id} className="mb-3">
                                <div className="flex justify-between font-bold border-b pb-2 mb-2"><span>{new Date(t.date).toLocaleDateString()}</span><span className="text-green-600">₹{t.total}</span></div>
                                {t.items.map((i, idx) => <div key={idx} className="flex justify-between text-sm text-gray-600"><span>{i.name} x{i.qty}</span><span>{i.price * i.qty}</span></div>)}
                                <Btn variant="secondary" className="w-full mt-3 py-2 text-xs" onClick={() => generatePDF(t)}><Icon name="download" size={14}/> PDF Bill</Btn>
                            </Card>
                        ))}
                    </div>
                </div>
            );

            if (view === "admin") return (
                <div className="flex flex-col h-screen w-full bg-gray-50 text-gray-900 font-sans">
                    <div className="bg-white p-4 shadow-sm z-30 sticky top-0 flex justify-between items-center">
                        <div><h1 className="text-xl font-extrabold text-blue-700">Morya POS</h1></div>
                        <div className="flex gap-2">
                            {tab === 'inventory' && <Btn onClick={() => { setSelItem({ name: '', variant: 'Std', price: '', stock: '', type: 'standard', colorStock: {} }); setActiveModal('edit'); }} className="py-2 h-9 text-xs">New</Btn>}
                            <button onClick={logout} className="p-2 bg-gray-100 rounded-full"><Icon name="log-out"/></button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-48">
                        {tab === 'pos' && (
                            <div className="space-y-3">
                                <Btn onClick={()=>setActiveModal('quick')} variant="purple" className="w-full mb-2"><Icon name="zap"/> Quick Sell</Btn>
                                <input className="w-full p-3 rounded-xl border bg-white" placeholder="Search Inventory..." value={search} onChange={e => setSearch(e.target.value)} />
                                {inv.filter(p => p.name.toLowerCase().includes(search.toLowerCase())).map(p => (
                                    <Card key={p.id} className="flex justify-between items-center active:scale-[0.99]">
                                        <div onClick={() => { if(p.type === 'has_colors') { setSelItem(p); setActiveModal('color'); setTimeout(()=>colorInputRef.current?.focus(), 100); } else addToCart(p); }} className="flex-1">
                                            <div className="font-bold text-lg">{p.name}</div>
                                            <div className="text-xs text-gray-400">Stock: {p.stock}</div>
                                        </div>
                                        <div className="flex flex-col items-end gap-1">
                                            <span className="font-bold text-xl text-blue-700">₹{p.price}</span>
                                            <Btn onClick={() => { if(p.type === 'has_colors') { setSelItem(p); setActiveModal('color'); } else addToCart(p); }} className="py-1 px-4 text-xs h-8">Add</Btn>
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        )}

                        {tab === 'inventory' && (
                            <div className="space-y-3">
                                {inv.map(p => (
                                    <Card key={p.id} className="relative">
                                        <div className="flex justify-between items-center mb-2">
                                            <div><div className="font-bold">{p.name}</div><div className="text-sm text-gray-500">{p.variant}</div></div>
                                            <div className="text-right"><div className="font-bold text-green-600">₹{p.price}</div><div className="text-xs text-gray-400">Qty: {p.stock}</div></div>
                                        </div>
                                        <div className="flex gap-2 border-t pt-2 mt-2">
                                            <Btn onClick={() => { setSelItem(p); setActiveModal(p.type==='has_colors'?'manage_stock':'edit'); }} variant="secondary" className="flex-1 py-2 text-xs">Edit/Stock</Btn>
                                            <button onClick={() => { if(confirm("Delete?")) window.dbSet(window.dbRef(window.db, 'inventory/' + p.id), null); }} className="p-2 bg-red-50 text-red-500 rounded-lg"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        )}
                        
                        {tab === 'history' && (
                            <div className="space-y-3">
                                <Card className="bg-blue-600 text-white"><div className="text-sm opacity-80">Total Sales</div><div className="text-3xl font-bold">₹{txs.reduce((s, t) => s + t.total, 0)}</div></Card>
                                {txs.slice().reverse().map(t => (
                                    <Card key={t.id} onClick={() => { setLastBill(t); setActiveModal('receipt'); }}>
                                        <div className="flex justify-between font-bold"><span>{t.customerName}</span><span className="text-green-600">₹{t.total}</span></div>
                                        <div className="text-xs text-gray-400">{new Date(t.date).toLocaleString()}</div>
                                    </Card>
                                ))}
                            </div>
                        )}
                    </div>

                    {cart.length > 0 && tab === 'pos' && (
                        <div onClick={() => setActiveModal('checkout')} className="fixed bottom-24 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center z-40 animate-up cursor-pointer">
                            <div className="flex items-center gap-3"><span className="bg-gray-700 px-3 py-1 rounded-lg font-bold">{cart.reduce((s, i) => s + i.qty, 0)}</span><span className="font-bold text-xl">₹{cart.reduce((s, i) => s + (i.price * i.qty), 0)}</span></div>
                            <div className="flex items-center gap-2 font-bold text-blue-300">Checkout <Icon name="arrow-right"/></div>
                        </div>
                    )}

                    <div className="bg-white border-t h-16 flex justify-around items-center z-50 absolute bottom-0 w-full">
                        {['pos', 'inventory', 'history'].map(t => (
                            <button key={t} onClick={() => setTab(t)} className={`flex flex-col items-center w-full py-2 ${tab === t ? 'text-blue-600' : 'text-gray-400'}`}>
                                <Icon name={t === 'pos' ? 'smartphone' : t === 'inventory' ? 'package' : 'history'}/><span className="text-[10px] font-bold mt-1 uppercase">{t === 'pos' ? 'Sale' : t}</span>
                            </button>
                        ))}
                    </div>

                    {/* Modals */}
                    {activeModal === 'quick' && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 relative">
                                <h3 className="font-bold text-xl mb-4">Quick Sell</h3>
                                <input id="qName" placeholder="Item Name" className="w-full p-3 border rounded-xl mb-3"/>
                                <div className="flex gap-2 mb-3"><input id="qPrice" type="number" placeholder="Price" className="w-full p-3 border rounded-xl"/><input id="qQty" type="number" placeholder="Qty" defaultValue="1" className="w-full p-3 border rounded-xl"/></div>
                                <Btn onClick={()=>{
                                    const n=document.getElementById('qName').value, p=document.getElementById('qPrice').value, q=document.getElementById('qQty').value;
                                    if(n && p) addToCart({id:'QS'+Date.now(), name:n, price:p, type:'custom'}, q, null, true);
                                }} className="w-full">Add to Bill</Btn>
                                <button onClick={()=>setActiveModal(null)} className="w-full py-3 text-gray-400 mt-2">Cancel</button>
                            </div>
                        </div>
                    )}

                    {activeModal === 'color' && selItem && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 relative">
                                <button onClick={() => setActiveModal(null)} className="absolute right-4 top-4 bg-gray-100 p-2 rounded-full"><Icon name="x"/></button>
                                <h3 className="text-xl font-bold text-center mb-1">Select Color</h3><p className="text-center text-xs mb-4">{selItem.name}</p>
                                <input ref={colorInputRef} type="number" className="w-full text-center text-4xl font-bold p-4 bg-gray-100 rounded-xl mb-4" placeholder="#" value={selColor} onChange={e => setSelColor(e.target.value)} onKeyDown={e => { if(e.key === 'Enter') addToCart(selItem, 1, selColor); }} />
                                <Btn onClick={() => addToCart(selItem, 1, selColor)} className="w-full text-lg">ADD TO BILL</Btn>
                            </div>
                        </div>
                    )}

                    {activeModal === 'checkout' && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-end justify-center backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md rounded-t-3xl p-6 h-[85vh] flex flex-col animate-up shadow-2xl">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Checkout</h2><button onClick={() => setActiveModal(null)}><Icon name="x"/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-4 mb-4">
                                    {cart.map(i => (
                                        <div key={i.cartId} className="flex justify-between items-center border-b pb-2">
                                            <div><div className="font-bold">{i.name}</div><div className="text-sm text-blue-600">{i.variant}</div></div>
                                            <div className="flex items-center gap-3"><div className="text-right"><div className="font-bold">₹{i.price * i.qty}</div><div className="text-xs text-gray-400">Qty: {i.qty}</div></div><button onClick={() => setCart(cart.filter(x => x.cartId !== i.cartId))} className="p-2 bg-red-50 text-red-600 rounded-full"><Icon name="trash-2" size={16}/></button></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="space-y-3 pt-4 border-t relative">
                                    {/* AUTOCOMPLETE DROPDOWN */}
                                    <div className="relative">
                                        <input className="w-full p-3 bg-gray-50 rounded-xl mb-2" placeholder="Customer Name (Type to search)" value={custData.name} onChange={e => handleCustInput('name', e.target.value)}/>
                                        {suggestions.length > 0 && (
                                            <div className="absolute bottom-full left-0 w-full bg-white shadow-xl border rounded-xl mb-2 z-50 overflow-hidden">
                                                {suggestions.map((s, idx) => (
                                                    <div key={idx} onClick={() => selectSuggestion(s)} className="p-3 border-b hover:bg-blue-50 flex justify-between items-center cursor-pointer">
                                                        <span className="font-bold">{s.name}</span><span className="text-xs text-gray-500">{s.mobile}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <input type="tel" className="w-full p-3 bg-gray-50 rounded-xl" placeholder="Mobile Number" value={custData.mobile} onChange={e => handleCustInput('mobile', e.target.value)}/>
                                    <Btn variant="black" className="w-full py-4 text-lg" onClick={processPayment}>CONFIRM PAYMENT</Btn>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'receipt' && lastBill && (
                        <div className="fixed inset-0 bg-gray-900/95 z-[70] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="check" size={32}/></div>
                                <h2 className="text-2xl font-bold mb-1">Payment Done!</h2><p className="text-gray-500 mb-6 font-mono text-lg">₹{lastBill.total}</p>
                                <div className="space-y-3">
                                    <Btn variant="black" className="w-full py-4" onClick={() => generatePDF(lastBill)}><Icon name="file-text"/> Download PDF</Btn>
                                    <Btn variant="secondary" className="w-full py-4" onClick={() => printText(lastBill)}><Icon name="printer"/> Text Print (RawBT)</Btn>
                                    <Btn variant="green" className="w-full py-4" onClick={() => window.open(`https://wa.me/91${lastBill.customerMobile}?text=${encodeURIComponent(`*MORYA POS*\nBill #${lastBill.id.slice(-6)}\nAmount: ₹${lastBill.total}`)}`, '_blank')}><Icon name="message-circle"/> WhatsApp</Btn>
                                </div>
                                <button onClick={() => setActiveModal(null)} className="mt-6 text-gray-400 text-sm underline">Close</button>
                            </div>
                        </div>
                    )}

                    {activeModal === 'edit' && selItem && (
                        <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <h3 className="text-xl font-bold mb-4">{selItem.id ? 'Edit' : 'New'}</h3>
                                <div className="space-y-3">
                                    <select className="w-full p-3 border rounded-lg bg-white" value={selItem.type} onChange={e => setSelItem({...selItem, type: e.target.value})}><option value="standard">Standard</option><option value="has_colors">Color Tracked</option></select>
                                    <input className="w-full p-3 border rounded-lg" placeholder="Name" value={selItem.name} onChange={e => setSelItem({...selItem, name: e.target.value})}/>
                                    <input className="w-full p-3 border rounded-lg" placeholder="Variant" value={selItem.variant} onChange={e => setSelItem({...selItem, variant: e.target.value})}/>
                                    <div className="flex gap-2"><input type="number" className="w-full p-3 border rounded-lg" placeholder="Price" value={selItem.price} onChange={e => setSelItem({...selItem, price: e.target.value})}/><input type="number" className="w-full p-3 border rounded-lg" placeholder="Stock" value={selItem.stock} onChange={e => setSelItem({...selItem, stock: e.target.value})}/></div>
                                    <Btn onClick={saveItemToCloud} className="w-full mt-2">Save</Btn>
                                    <button onClick={() => setActiveModal(null)} className="w-full py-3 text-gray-400">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'manage_stock' && selItem && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 h-[70vh] flex flex-col shadow-2xl">
                                <div className="flex justify-between items-center mb-4"><div><h3 className="font-bold text-lg">Stock</h3><p className="text-xs text-gray-500">{selItem.name}</p></div><button onClick={() => setActiveModal(null)}><Icon name="x"/></button></div>
                                <div className="flex gap-2 mb-4 p-3 bg-blue-50 rounded-xl">
                                    <input id="sc" type="number" placeholder="#" className="w-1/2 p-2 rounded border"/><input id="sq" type="number" placeholder="Qty" className="w-1/3 p-2 rounded border"/>
                                    <Btn onClick={() => {
                                        const c = document.getElementById('sc').value, q = document.getElementById('sq').value;
                                        if(!c || !q) return;
                                        const newItem = { ...selItem, stock: parseInt(selItem.stock) + parseInt(q), colorStock: { ...(selItem.colorStock||{}), [c]: (selItem.colorStock?.[c]||0) + parseInt(q) } };
                                        setSelItem(newItem); // Optimistic UI
                                        window.dbSet(window.dbRef(window.db, 'inventory/' + selItem.id), newItem);
                                        document.getElementById('sc').value = ''; document.getElementById('sq').value = '';
                                    }} className="text-xs">Add</Btn>
                                </div>
                                <div className="flex-1 overflow-y-auto bg-gray-50 rounded-xl p-2 border"><table className="w-full text-sm"><thead className="text-gray-500 text-xs border-b"><tr><th className="text-left pb-2">Color #</th><th className="text-right pb-2">Qty</th></tr></thead><tbody className="divide-y">{Object.entries(selItem.colorStock || {}).map(([c, q]) => <tr key={c}><td className="py-2 font-bold text-gray-700">#{c}</td><td className="py-2 text-right font-bold text-blue-600">{q}</td></tr>)}</tbody></table></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
